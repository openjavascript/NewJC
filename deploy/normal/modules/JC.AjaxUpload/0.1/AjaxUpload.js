(function(e,t){e("JC.AjaxUpload",["JC.BaseMVC","JC.Panel"],function(){function t(e){if(t.getInstance(e))return t.getInstance(e);if(!e.hasClass("js_compAjaxUpload"))return t.init(e);t.getInstance(e,this),this._model=new t.Model(e),this._view=new t.View(this._model),JC.log("AjaxUpload init",(new Date).getTime()),this._init()}return JC.AjaxUpload=t,JC.f.addAutoInit&&JC.f.addAutoInit(t),t.getInstance=function(e,n){typeof e=="string"&&!/</.test(e)&&(e=$(e));if(!e||!e.length||typeof e=="string")return;return typeof n!="undefined"&&e.data(t.Model._instanceName,n),e.data(t.Model._instanceName)},t.init=function(e){var n=[];return e=$(e||document),e.hasClass("js_compAjaxUpload")?n.push(new t(e)):e.find("input.js_compAjaxUpload, button.js_compAjaxUpload").each(function(){n.push(new t($(this)))}),n},t.frameFileName="default.html",t.randomFrame=!1,t._FRAME_DIR="modules/JC.AjaxUpload/0.1/frame/",e&&!e.amd&&(t._FRAME_DIR="comps/AjaxUpload/frame/"),t._INS_COUNT=1,BaseMVC.build(t),JC.f.extendObject(t.prototype,{_beforeInit:function(){var e=this},_initHanlderEvent:function(){var e=this,t=e._model.cauViewFileBox();t&&t.length&&t.delegate(".js_clearAjaxUpload","click",function(){e.clear()}),e.on("FrameLoad",function(t){var n=e._model.frame().prop("contentWindow");if(!n||!n.initPage)return;n.initPage(e,e._model);if(e._model.INITED)return;e._model.INITED=!0,e._model.cauDefaultHide()&&setTimeout(function(){e._model.frame().hide(),e._model.selector().hide()},1),e._model.swfu(n),e._model.uploadReady(!0),e.trigger("UploadReady")}),e.on("ERR_FILE_SIZE",function(t,n){e._view.errFileSize(n),e._view.updateChange()}),e.on("ERR_FILE_EXT",function(t,n){e._view.errFileExt(n),e._view.updateChange()}),e.on("BeforeUpload",function(t){e._view.beforeUpload(),e._model.cauBeforeUploadCallback()&&e._model.cauBeforeUploadCallback().call(e,t,e._model.selector(),e._model.frame())}),e.on("UploadDone",function(t,n,r){if(r)return;var i=!1,s=n;try{typeof n=="string"&&(n=$.parseJSON(n))}catch(o){n={},i=!0}i?(e._view.errFatalError(s),e._view.updateChange(),e._model.cauUploadErrorCallback()&&e._model.cauUploadErrorCallback().call(e,n,e._model.selector(),e._model.frame())):(n.errorno?(e._view.errUpload(n),e._view.updateChange()):e._view.updateChange(n),e._model.cauUploadDoneCallback()&&e._model.cauUploadDoneCallback().call(e,n,e._model.selector(),e._model.frame()))}),e.on("AUUpdateLayout",function(t,n,r,i){e._view.updateLayout(n,r,i)}),e.on("init",function(){e._model.loadSWF(e._model.getParams())}),e.on("disable",function(){e._model.uploadReady()||e._model.beforeReadyQueue(function(){e._view.disable()}),e._view.disable()}),e.on("enable",function(){e._model.uploadReady()||e._model.beforeReadyQueue(function(){e._view.enable()}),e._view.enable()}),e.on("UploadReady",function(){var t=e._model.beforeReadyQueue();setTimeout(function(){$.each(t,function(e,t){t()})},10)})},_inited:function(){var e=this;e._view.loadFrame(),t.getInstance(e._model.frame(),e),e.trigger("inited")},disable:function(){return this.trigger("disable"),this},enable:function(){return this.trigger("enable"),this},update:function(e){var t=this;return $(t._view).trigger("UpdateDefaultStatus"),e&&t.trigger("UploadDone",[e]),this},clear:function(){var e=this;return $(e._view).trigger("UpdateDefaultStatus"),this}}),t.Model._instanceName="AjaxUpload",JC.f.extendObject(t.Model.prototype,{init:function(){},cauStyle:function(){return this.attrProp("cauStyle")},cauButtonText:function(){return this.attrProp("cauButtonText")},cauUrl:function(){return this.attrProp("cauUrl")},cauFileExt:function(){return this.stringProp("cauFileExt")},cauFileSize:function(){return this.stringProp("cauFileSize")||"1024 MB"},cauFileName:function(){return this.attrProp("cauFileName")||this.attrProp("name")},cauLabelKey:function(){return this.attrProp("cauLabelKey")||"name"},cauValueKey:function(){return this.attrProp("cauValueKey")||"url"},cauSaveLabelSelector:function(){var e=this.selectorProp("cauSaveLabelSelector");return e},cauStatusLabel:function(){return this.selectorProp("cauStatusLabel")},cauDisplayLabel:function(){return this.selectorProp("cauDisplayLabel")},cauDisplayLabelCallback:function(){return this.callbackProp("cauDisplayLabelCallback")},cauHideButton:function(){var e=!1;return this.is("[cauHideButton]")&&(e=this.boolProp(this.attrProp("cauHideButton"))),e},cauDefaultHide:function(){return this.boolProp("cauDefaultHide")},cauBeforeUploadCallback:function(){return this.callbackProp("cauBeforeUploadCallback")},cauUploadDoneCallback:function(){return this.callbackProp("cauUploadDoneCallback")},cauUploadErrorCallback:function(){return this.callbackProp("cauUploadErrorCallback")},cauJSONPName:function(){var e=t.JSONPName;return e=JC.f.getUrlParam(this.cauUrl(),"callback")||e,e=this.attrProp("cauJSONPName")||e,e},framePath:function(){var e=this.attrProp("cauFrameFileName")||t.frameFileName,n=JC.f.printf("{0}{1}{2}",JC.PATH,t._FRAME_DIR,e);return this.randomFrame()&&(n=JC.f.addUrlParams(n,{rnd:(new Date).getTime()})),n},cauButtonAfter:function(){return this.boolProp("cauButtonAfter")},randomFrame:function(){var e=t.randomFrame;return this.selector().is("[cauRandomFrame]")&&(e=this.boolProp("cauRandomFrame")),e},frame:function(){if(!this._iframe){var e=t.frameTpl;this.selector().is("[cauFrameScriptTpl]")&&(e=JC.f.scriptContent(JC.f.parentSelector(this.selector(),this.selector().attr("cauFrameScriptTpl")))),this._iframe=$(t.frameTpl)}return this._iframe},cauCancelCallback:function(){return this.callbackProp("cauCancelCallback")},uploadReady:function(e){return typeof e!="undefined"&&(this._uploadReady=e),this._uploadReady},beforeReadyQueue:function(e){return!this._beforeReadyQueue&&(this._beforeReadyQueue=[]),e&&this._beforeReadyQueue.push(e),this._beforeReadyQueue},cauButtonAutoStatus:function(){var e=!0;return this.is("[cauButtonAutoStatus]")&&(e=this.boolProp("cauButtonAutoStatus")),e},swfu:function(e){return typeof e!="undefined"&&(this._swfu=e),this._swfu},cauViewFileBox:function(){return this.selectorProp("cauViewFileBox")},cauViewFileBoxItemTpl:function(){var e=['<a href="javascript:;" data-name="{0}" data-url="{1}" class="js_clearAjaxUpload">清除</a>','&nbsp;<a href="{1}" target="_blank" data-name="{0}" data-url="{1}" class="js_viewAjaxUpload">查看</a>'].join(""),t;return this.is("[cauViewFileBoxItemTpl]")&&(t=this.selectorProp("cauViewFileBoxItemTpl"))&&t.length&&(e=JC.f.scriptContent(t)),e}}),JC.f.extendObject(t.View.prototype,{init:function(){var e=this;$(e).on("update_viewFileBox",function(t,n,r){var i=e._model.cauViewFileBox(),s;if(!i||!i.length)return;s=e._model.cauViewFileBoxItemTpl(),s=JC.f.printf(s,n,r),i.html(s)}),$(e).on("clear_viewFileBox",function(){var t=e._model.cauViewFileBox();if(!t||!t.length)return;t.html("")}),$(e).on("UpdateDefaultStatus",function(t){var n=e._model.cauStatusLabel(),r=e._model.cauDisplayLabel();e.updateChange(),e._model.frame().show(),n&&n.length&&n.hide(),r&&r.length&&r.hide(),(e._model.selector().attr("type")||"").toLowerCase()!="hidden"&&e._model.selector().show(),$(e).trigger("clear_viewFileBox"),e.trigger("UploadComplete")}),$(e).on("CAUUpdate",function(t,n){var r=e._model.cauDisplayLabel(),i="",s="";typeof n!="undefined"&&(s=n.data[e._model.cauValueKey()],i=n.data[e._model.cauLabelKey()],e._model.selector().val(s),e._model.cauSaveLabelSelector()&&e._model.cauSaveLabelSelector().val(i)),e._model.cauDisplayLabelCallback()?i=e._model.cauDisplayLabelCallback().call(e._model.selector(),n,i,s):i=JC.f.printf('<a href="{0}" class="green js_auLink" target="_blank">{1}</a>',s,i),r&&r.length&&r.html(i)})},loadFrame:function(){var e=this,t=e._model.framePath(),n=e._model.frame();n.attr("src",t),n.on("load",function(){e.trigger("FrameLoad")}),e._model.cauButtonAfter()?e.selector().after(n):e.selector().before(n)},beforeUpload:function(){var e=this,t=e._model.cauStatusLabel();this.updateChange(null,!0),t&&t.length&&(e._model.selector().hide(),e._model.frame().hide(),t.show())},updateChange:function(e,t){var n=this,r=n._model.cauStatusLabel(),i=n._model.cauDisplayLabel(),s,o;r&&r.length&&!t&&(n._model.selector().show(),n._model.frame().show(),r.hide()),i&&i.length&&i.html(""),n._model.selector().val(""),n._model.cauSaveLabelSelector()&&n._model.cauSaveLabelSelector().val("");if(e&&"errorno"in e&&!e.errorno){$(n).trigger("CAUUpdate",[e]),s=e.data[n._model.cauLabelKey()],o=e.data[n._model.cauValueKey()],n._model.selector().val()&&n._model.selector().is(":visible")&&n._model.selector().prop("type").toLowerCase()=="text"&&n._model.selector().trigger("blur"),$(n).trigger("update_viewFileBox",[s,o]);if(i&&i.length){n._model.selector().hide(),n._model.is("[cauHideButton]")?n._model.cauHideButton()&&n._model.frame().hide():n._model.frame().hide(),i.show();return}}},updateLayout:function(e,t,n){if(!e||!t)return;var r=this;r._model.frame().css({width:e+"px",height:t+"px"})},errUpload:function(e){var t=this,n=t._model.callbackProp("cauBeforeUploadErrCallback"),r=t._model.callbackProp("cauUploadErrCallback");n&&n.call(t._model.selector(),e);if(r)r.call(t._model.selector(),e,t._model.frame());else{var i=e&&e.errmsg?e.errmsg:"上传失败, 请重试!";JC.Dialog?JC.Dialog.alert(i,1):alert(i)}},errFileExt:function(e){var t=this,n=t._model.callbackProp("cauFileExtErrCallback");if(n)n.call(t._model.selector(),t._model.cauFileExt(),e,t._model.frame());else{var r=JC.f.printf('类型错误, 允许上传的文件类型: {0} <p class="auExtErr" style="color:red">{1}</p>',t._model.cauFileExt(),e);JC.Dialog?JC.Dialog.alert(r,1):alert(r)}},errFileSize:function(e){var t=this,n=t._model.callbackProp("cauFileExtErrCallback");if(n)n.call(t._model.selector(),t._model.cauFileSize(),e,t._model.frame());else{var r=JC.f.printf('文件大小错误, 允许上传的文件大小为: {0} <p class="auExtErr" style="color:red">{1}</p>',t._model.cauFileSize(),e);JC.Dialog?JC.Dialog.alert(r,1):alert(r)}},errFatalError:function(e){var t=this,n=t._model.callbackProp("cauFatalErrorCallback");if(n)n.call(t._model.selector(),e,t._model.frame());else{var r=JC.f.printf('服务端错误, 无法解析返回数据: <p class="auExtErr" style="color:red">{0}</p>',e);JC.Dialog?JC.Dialog.alert(r,1):alert(r)}},disable:function(){var e=this,t=e._model.swfu();t&&t.setButtonDisabled(!0)},enable:function(){var e=this,t=e._model.swfu();t&&t.setButtonDisabled(!1)}}),$.event.special.AjaxUploadShowEvent={show:function(e){e.handler&&e.handler()}},t.frameTpl=JC.f.printf('<iframe src="about:blank" frameborder="0" class="AUIframe" style="{0}"></iframe>',"width: 84px; height: 24px;cursor: pointer; vertical-align: middle;"),$(document).ready(function(){t.autoInit&&t.init()}),JC.AjaxUpload})})(typeof define=="function"&&define.amd?define:function(e,t,n){typeof e=="function"&&(n=e),typeof t=="function"&&(n=t),n&&n()},window);