(function(e,t){e("Bizs.CommonModify",["JC.BaseMVC"],function(){function e(t){t&&(t=$(t));if(e._instance)return e._instance;e._instance||(e._instance=this),this._model=new e.Model(t),this._view=new e.View(this._model),this._init(),t&&t.length&&this.process(t)}return window.Bizs.CommonModify=e,e.prototype={_beforeInit:function(){JC.log("CommonModify _beforeInit",(new Date).getTime())},_initHanlderEvent:function(){var e=this;return e.on("add",function(t,n,r){e._model.cmaddcallback()&&e._model.cmaddcallback().call(e.selector(),e,n,e._model.cmitem(),r)}),e.on("del",function(t,n,r){e._model.cmdelcallback()&&e._model.cmdelcallback().call(e.selector(),e,r)}),e.on("done",function(t,n,r){e._model.cmdonecallback()&&e._model.cmdonecallback().call(e.selector(),e,r)}),e},_inited:function(){JC.log("CommonModify _inited",(new Date).getTime())},selector:function(){return this._model.selector()},on:function(e,t){return $(this).on(e,t),this},trigger:function(e,t){return $(this).trigger(e,t),this},process:function(e){if(!e||!(e=$(e)).length)return this;this._model.selector(e);switch(this._model.action()){case"del":this._view.del();break;default:this._view.add()}},cmitem:function(){return this._model.cmitem()}},e.getInstance=function(){return!e._instance&&(e._instance=new e),e._instance},e._instance=null,e.isCommonModify=function(e){var t;return e&&(e=$(e)).length&&(t=e.is("[CommonModifylayout]")),t},e.doneCallback=null,e.tplFilterCallback=null,e.beforeAddCallback=null,e.addCallback=null,e.beforeDelCallabck=null,e.delCallback=null,BaseMVC.buildModel(e),e.Model.prototype={init:function(){return this},selector:function(e){return e&&(e=$(e))&&(this._selector=e),this._selector},layout:function(){},action:function(){var e="add",t;return(t=this.selector().attr("cmaction"))&&(e=t.toLowerCase()),e},cmtemplate:function(){var e="",t;return t=JC.f.parentSelector(this.selector(),this.selector().attr("cmtemplate")),(!t||!t.length)&&(t=JC.f.parentSelector(this.selector(),this.selector().attr("cmtpl"))),this.selector()&&t&&t.length&&(e=JC.f.scriptContent(t)),e},cmdonecallback:function(){var t=e.doneCallback,n;return this.selector()&&(n=this.selector().attr("cmdonecallback"))&&(n=window[n])&&(t=n),t},cmtplfiltercallback:function(){var t=e.tplFilterCallback,n;return this.selector()&&(n=this.selector().attr("cmtplfiltercallback"))&&(n=window[n])&&(t=n),t},cmAddedItemsSelector:function(){var e=this.selectorProp("cmAddedItemsSelector");return e},cmMaxItems:function(){var e=this.intProp("cmMaxItems");return e},cmOutRangeMsg:function(){var e=JC.f.printf(this.attrProp("cmOutRangeMsg")||"最多只能上传 {0}个文件!",this.cmMaxItems());return e},cmaddcallback:function(){var t=e.addCallback,n;return this.selector()&&(n=this.selector().attr("cmaddcallback"))&&(n=window[n])&&(t=n),t},cmdelcallback:function(){var t=e.delCallback,n;return this.selector()&&(n=this.selector().attr("cmdelcallback"))&&(n=window[n])&&(t=n),t},cmbeforeaddcallabck:function(){var t=e.beforeAddCallback,n;return this.selector()&&(n=this.selector().attr("cmbeforeaddcallabck"))&&(n=window[n])&&(t=n),t},cmbeforedelcallback:function(){var t=e.beforeDelCallabck,n;return this.selector()&&(n=this.selector().attr("cmbeforedelcallback"))&&(n=window[n])&&(t=n),t},cmitem:function(){var e,t;return this.selector()&&(t=this.selector().attr("cmitem"))&&(e=JC.f.parentSelector(this.selector(),t)),e},cmappendtype:function(){var e=this.selector().attr("cmappendtype")||"after";return e}},BaseMVC.buildView(e),e.View.prototype={init:function(){return this},add:function(){JC.log("Bizs.CommonModify view add",(new Date).getTime());var e=this,t=e._model.cmtemplate(),n=e._model.cmitem(),r=n.parent(),i,s=e._model.cmMaxItems(),o=e._model.cmAddedItemsSelector();if(s&&o&&o.length&&o.length>=s){var u=e._model.cmOutRangeMsg();JC.msgbox?JC.msgbox(u,e._model.selector(),2):alert(u);return}if(e._model.cmbeforeaddcallabck()&&e._model.cmbeforeaddcallabck().call(e._model.selector(),n,r)===!1)return;e._model.cmtplfiltercallback()&&(t=e._model.cmtplfiltercallback().call(e._model.selector(),t,n,r)),t=t.replace(/<([\d]+)>/g,"{$1}"),JC.log("_item:",n,n.length);if(!(t&&n&&n.length))return;i=$(t);switch(e._model.cmappendtype()){case"appendTo":i.appendTo(n);break;case"before":n.before(i);break;default:n.after(i)}JC.f.autoInit&&JC.f.autoInit(i),$(e).trigger("TriggerEvent",["add",i,r]),$(e).trigger("TriggerEvent",["done",i,r])},del:function(){JC.log("Bizs.CommonModify view del",(new Date).getTime());var e=this,t=e._model.cmitem(),n=t.parent();if(e._model.cmbeforedelcallback()&&e._model.cmbeforedelcallback().call(e._model.selector(),t,n)===!1)return;t&&t.length&&t.remove(),$(e).trigger("TriggerEvent",["del",t,n]),$(e).trigger("TriggerEvent",["done",t,n])}},BaseMVC.build(e),$(document).delegate("a.js_autoCommonModify, button.js_autoCommonModify, a.js_bizsCommonModify, button.js_bizsCommonModify","click",function(t){var n=$(this);n.prop("nodeName").toLowerCase()=="a"&&t.preventDefault(),e.getInstance().process(n)}),Bizs.CommonModify})})(typeof define=="function"&&define.amd?define:function(e,t,n){typeof e=="function"&&(n=e),typeof t=="function"&&(n=t),n&&n()},window);