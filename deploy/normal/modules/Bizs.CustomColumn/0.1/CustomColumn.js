(function(e,t){e("Bizs.CustomColumn",["JC.Panel","JC.Valid","Bizs.FormLogic"],function(){function n(e){e&&(e=$(e));if(JC.BaseMVC.getInstance(e,n))return JC.BaseMVC.getInstance(e,n);JC.BaseMVC.getInstance(e,n,this),this._model=new n.Model(e),this._view=new n.View(this._model),this._init(),JC.log(n.Model._instanceName,"all inited",(new Date).getTime())}JC.use&&(!JC.Panel&&JC.use("JC.Panel"),!JC.Valid&&JC.use("JC.Valid"),!Bizs.FormLogic&&JC.use("Bizs.FormLogic"));var e=$(document),t=$(window);return Bizs.CustomColumn=n,n.init=function(e){var t=[];return e=$(e||document),e.length&&(e.hasClass("js_bizCustomColumn")?t.push(new n(e)):e.find("a.js_bizCustomColumn, button.js_bizCustomColumn").each(function(){t.push(new n(this))})),t},n.ID_COUNT=1,window.BizsCustomColumnFormDoneCallback=function(e,t,n){var r=$(this),i;e.errorno?i=JC.alert(e.errmsg||"操作失败, 请重新尝试!",t,1):i=JC.msgbox(e.errmsg||"操作成功",t,0,function(){JC.f.reloadPage(n._model.formAjaxDoneAction()||JC.f.urlDetect("URL"))})},window.BizsCustomColumnFormAfterProcessCallback=function(t,n){var r=$(this),i=JC.f.parentSelector(r,"div.UPanel"),s;if(!i)return;i=JC.Panel.getInstance(i);if(!i)return;s=i.CustomColumnIns;if(!s)return;var o=s._model.saveSelector(),u,a;if(o&&o.length){u=[],a=i.selector().find("input.js_typeItem:checked"),s.trigger("update_selected_status");if(a.length<s._model.minCol())return!1;if(a.length>s._model.maxCol())return!1;a.each(function(){u.push($(this).val().trim())}),o.val(u.join(","))}},JC.BaseMVC.build(n),JC.f.extendObject(n.prototype,{_beforeInit:function(){JC.log("CustomColumn _beforeInit",(new Date).getTime())},_initHanlderEvent:function(){var e=this;e.on("inited",function(){}),e.on("showPopup",function(){e._view.showPopup()}),e.on("hidePopup",function(){e.view.hidePopup()}),e.on("panel_inited",function(t,n){e._model.currentPanel(n),n.CustomColumnIns=e}),e.on("update_default",function(t,n){n.selector().find("input.js_typeItem").each(function(){var t=$(this),n=e._model.data()[t.attr("data-topIndex")].content[t.attr("data-subIndex")];n.isdefault?t.prop("checked",!0):t.prop("checked",!1)})}),e.on("update_custom",function(t,n){n.selector().find("input.js_typeItem").each(function(){var t=$(this),n=e._model.data()[t.attr("data-topIndex")].content[t.attr("data-subIndex")];n.ison?t.prop("checked",!0):t.prop("checked",!1)})}),e.on("update_selected_status",function(){var t=e._model.currentPanel(),n,r=t.find("em.js_bccErrEm");n=t.selector().find("input.js_typeItem:checked");if(n.length<e._model.minCol()){r.html("请选择数据列, 最少需要选择"+e._model.minCol()+"个数据列！").show();return}if(n.length>e._model.maxCol()){r.html("最多只能选择"+e._model.maxCol()+"个数据列！").show();return}r.hide()})},_inited:function(){JC.log("CustomColumn _inited",(new Date).getTime()),this.trigger("inited")},show:function(){this.trigger("showPopup")},hide:function(){this.trigger("hidePopup")},close:function(){this.trigger("hidePopup")}}),n.Model._instanceName="JCCustomColumn",JC.f.extendObject(n.Model.prototype,{init:function(){JC.log("CustomColumn.Model.init:",(new Date).getTime()),this._gid="CustomColumnIns_"+n.ID_COUNT,n.ID_COUNT++},currentPanel:function(e){return typeof e!="undefined"&&(this._currentPanel=e),this._currentPanel},gid:function(){return this._gid},url:function(){var e=this.attrProp("data-query")||this.attrProp("data-url")||"?";return e},id:function(){var e=this.attrProp("pagename")||this.attrProp("data-id")||"";return e},name:function(){var e=this.attrProp("data-name")||"selectedItem";return e},data:function(){return this._data||(this.is("[data-data]")&&(this._data=this.windowProp("data-data")),this.is("[data-scriptData]")&&(this._data=this.scriptDataProp("data-scriptData"))),this._data},typeSelector:function(){return this.attrProp("data-typeSelector")||"js_selectType"},saveSelector:function(){return this.is("[data-saveSelector]")?this.selectorProp("data-saveSelector"):this.selector().find("input.js_saveSelector")},maxCol:function(){return this.intProp("data-maxCol")||20},minCol:function(){return this.intProp("data-minCol")||1},tpl:function(){return this._tpl||this.is("[data-tpl]")&&(this._tpl=this.scriptTplProp("data-tpl")),this._tpl},formDoneCallback:function(){var e="BizsCustomColumnFormDoneCallback";return this.attrProp("data-formDoneCallback")&&this.windowProp("data-formDoneCallback")&&(e=this.attrProp("data-formDoneCallback")),e},formAfterProcessCallback:function(){var e="BizsCustomColumnFormAfterProcessCallback";return this.attrProp("data-formAfterProcessCallback")&&this.windowProp("data-formAfterProcessCallback")&&(e=this.attrProp("data-formAfterProcessCallback")),e},isDefault:function(){var e=!0,t=this;return $.each(t.data(),function(t,n){$.each(n.content,function(t,n){if(n.ison&&!n.isdefault||!n.ison&&!n.dftchk&&n.isdefault)return e=!1});if(!e)return!1}),e}}),JC.f.extendObject(n.View.prototype,{init:function(){JC.log("CustomColumn.View.init:",(new Date).getTime())},showPopup:function(){var e=this,t=e._model.tpl(),n,r=[],i=e._model.isDefault();$.each(e._model.data(),function(t,n){r.push("<dl>"),r.push("<dt>"),n.name&&r.push(n.groupName),r.push("</dt>"),r.push("<dd>"),n.content&&(r.push("<ul>"),$.each(n.content,function(n,s){if(!s)return;var o="",u="",a="";s.isdefault&&(a="js_isDefaultItem"),i?s.isdefault&&(o=' checked="checked" '):s.ison&&(o=' checked="checked" '),s.isdefault&&s.dftchk&&(o+=' disabled="disabled" ',u='<input name="{3}" value="{1}" type="hidden" class="">'),r.push(JC.f.printf('<li><label><input name="{3}" value="{1}"   type="checkbox" data-topIndex="{6}" data-subIndex="{7}" class="js_typeItem {5}" {4}>&nbsp;{2}{0}</label></li>',u,s.name,s.title,e._model.name(),o,a,t,n))}),r.push("</ul>")),r.push("</dd>"),r.push("</dl>")}),t=JC.f.printKey(t,{id:e._model.id(),url:e._model.url(),content:r.join(""),formDoneCallback:e._model.formDoneCallback(),formAfterProcessCallback:e._model.formAfterProcessCallback()}),n=JC.Dialog(t),e.trigger("panel_inited",[n]),i?n.find("input.js_defaultType").prop("checked",!0):n.find("input.js_customType").prop("checked",!0),n.find("input.js_customType").on("click",function(t){if(e._model.isDefault())return!1;e.trigger("update_custom",[n]),e.trigger("update_selected_status")}),n.selector().delegate("input.js_selectType","change",function(){var t=$(this);if(t.val()!="default")return;e.trigger("update_default",[n]),e.trigger("update_selected_status")}),n.selector().delegate("input.js_typeItem","change",function(){var t=$(this),r=e._model.data()[t.attr("data-topIndex")].content[t.attr("data-subIndex")];t.prop("checked")?r.ison=!0:r.ison=!1,e._model.isDefault()?n.find("input.js_defaultType").prop("checked",!0):n.find("input.js_customType").prop("checked",!0),e.trigger("update_selected_status")})}}),e.ready(function(){$(document).delegate("button.js_bizCustomColumn, a.js_bizCustomColumn","click",function(){var e=$(this),t=JC.BaseMVC.getInstance(e,n);t||(t=new n(e)),t&&t.show()})}),Bizs.CustomColumn})})(typeof define=="function"&&define.amd?define:function(e,t,n){typeof e=="function"&&(n=e),typeof t=="function"&&(n=t),n&&n()},window);