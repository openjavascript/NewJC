(function(e,t){e("JC.TableFreeze",["JC.BaseMVC"],function(){function e(t){t&&(t=$(t));if(e.getInstance(t))return e.getInstance(t);e.getInstance(t,this),this._model=new e.Model(t),this._view=new e.View(this._model),this._init()}return JC.TableFreeze=e,JC.f.addAutoInit&&JC.f.addAutoInit(e),e.getInstance=function(t,n){typeof t=="string"&&!/</.test(t)&&(t=$(t));if(!t||!t.length||typeof t=="string")return;return typeof n!="undefined"&&t.data(e.Model._instanceName,n),t.data(e.Model._instanceName)},e.init=function(t){var n=[];return t=$(t||document),t.length&&(t.hasClass("js_compTableFreeze")?n.push(new e(t)):t.find("div.js_compTableFreeze").each(function(){n.push(new e(this))})),n},BaseMVC.build(e),JC.f.extendObject(e.prototype,{_beforeInit:function(){},_initHanlderEvent:function(){var e=this;e.on("CTableFreezeUpdate",function(t){e._model.beforeCreateTableCallback()&&e._model.beforeCreateTableCallback().call(e,e.selector()),e._view.update(),e._model.afterCreateTableCallback()&&e._model.afterCreateTableCallback().call(e,e.selector());if(e._model.needHoverClass()){var n=e._model.hoverClass();if(!e._model.supportFreeze()||!e._model.supportScroll())e._model.selector().find("table>tbody>tr").on("mouseenter",function(){$(this).addClass(n)}).on("mouseleave",function(){$(this).removeClass(n)});else{var r="td.compTFEextraTd>div>table>tbody>tr",i="td.compTFEextraTd>div>table>tbody>tr.",s;$(document).undelegate(r,"mouseenter").delegate(r,"mouseenter",function(){var e=$(this),t=JC.f.getJqParent(e,"table.compTFEextraTable");s=t.find(i+e.data("linktr")).addClass(n)}).undelegate(r,"mouseleave").delegate(r,"mouseleave",function(){s&&s.length>0&&s.removeClass(n)})}}})},_inited:function(){var e=$(this);e.trigger("CTableFreezeUpdate")},update:function(){return this._view.update(),this},fixHeight:function(){var t=this,n=e.Model.saveWidth,r=t._model.selector(),i=r.prop("offsetWidth"),s=r.find("div.js-roll-table,div.js-fixed-table"),o=r.find("div.js-roll-table"),u=r.find("div.js-fixed-table"),a=0;return e.Model.windowWidth=$(window).width(),t._model.setHeight(),n<=i&&(s.each(function(){$(this).find("tr").height("auto")}),t._model.setHeight()),u.each(function(){a+=$(this).parent("td").prop("offsetWidth")}),o.css("width",i-a),t._model.fixWidth(),this}}),e.Model._instanceName="TableFreeze",e.Model.saveWidth=0,e.Model.windowWidth=0,JC.f.extendObject(e.Model.prototype,{init:function(){var e=this;this.sourceTable=this.selector().find("table").eq(0)},detachTable:function(){this.sourceTable.remove()},linkTpl:function(){var e=this,t;e.selector().find("table>tbody").length>0?t=e.selector().find("table>tbody>tr"):t=e.selector().find("table>tr"),t.each(function(e){$(this).attr("data-linktr","CTF"+e)})},createTplBox:function(){var e=this,t=e.freezeType(),n=e.tTpl(),r=e.selector(),i=e.colNum(),s,o,u,a,f,l,c,h,p,d;switch(t){case"prev":o=parseInt(e.freezeCols(),10),s=JC.f.printf(n,"js-fixed-table compTFPrevFixed","js-roll-table compTFPrevRoll"),r.append(s),c=JC.f.getJqParent(r.find(".js-fixed-table"),".compTFEextraTd"),h=JC.f.getJqParent(r.find(".js-roll-table"),".compTFEextraTd"),e.setWidth(0,c,o,h),u=r.find(".js-fixed-table>table>thead"),a=r.find(".js-fixed-table>table>tbody"),f=r.find(".js-roll-table>table>thead"),l=r.find(".js-roll-table>table>tbody"),e.createHdTpl(u,o),e.createBdTpl(a,o),e.createHdTpl(f,i-o),e.createBdTpl(l,i-o);break;case"last":o=parseInt(e.freezeCols(),10),s=JC.f.printf(n,"js-roll-table compTFLastRoll","js-fixed-table compTFLastFixed"),r.append(s),c=JC.f.getJqParent(r.find("div.js-roll-table"),"td.compTFEextraTd"),h=JC.f.getJqParent(r.find("div.js-fixed-table"),"td.compTFEextraTd"),e.setWidth(i-o,h,i,c),u=r.find("div.js-roll-table>table>thead"),a=r.find("div.js-roll-table>table>tbody"),f=r.find("div.js-fixed-table>table>thead"),l=r.find("div.js-fixed-table>table>tbody"),e.createHdTpl(u,i-o),e.createBdTpl(a,i-o),e.createHdTpl(f,o),e.createBdTpl(l,o);break;case"both":var v,m,g;o=parseInt(e.freezeCols()[0],10),v=parseInt(e.freezeCols()[1],10),s=JC.f.printf(n,"js-fixed-table compTFBothFixed","js-roll-table compTFBothRoll","js-fixed-table compTFBothFixed"),r.append(s),c=JC.f.getJqParent(r.find("div.js-fixed-table:eq(0)"),"td.compTFEextraTd"),h=JC.f.getJqParent(r.find("div.js-roll-table"),"td.compTFEextraTd"),p=JC.f.getJqParent(r.find("div.js-fixed-table:eq(1)"),"td.compTFEextraTd"),e.setWidth(0,c,o),e.setWidth(o,h,o+i-o-v),e.setWidth(o+i-o-v,p,i),u=r.find("div.js-fixed-table:eq(0)>table>thead"),a=r.find("div.js-fixed-table:eq(0)>table>tbody"),f=r.find("div.js-roll-table>table>thead"),l=r.find("div.js-roll-table>table>tbody"),m=r.find("div.js-fixed-table:eq(1)>table>thead"),g=r.find("div.js-fixed-table:eq(1)>table>tbody"),e.createHdTpl(u,o),e.createBdTpl(a,o),e.createHdTpl(f,i-o-v),e.createBdTpl(l,i-o-v),e.createHdTpl(m,v),e.createBdTpl(g,v)}r.find("div.js-roll-table>table").width(e.scrollwidth()),e.setHeight()},createHdTpl:function(e,t){var n=this,r=n.sourceTable,i=document.createDocumentFragment(),s=$(i);r.find("thead:eq(0)>tr").each(function(e,n){var r=0,i,o=$(n).get(0).cloneNode(!1);s.append(o),i=s.children("tr:last"),$(n).children("td,th").each(function(e,n){var s=$(this).attr("colspan");if(r>=t)return!1;$(this).appendTo(i),typeof s=="undefined"?r+=1:r+=parseInt(s,10)})}),s.appendTo(e)},createBdTpl:function(e,t){var n=this,r=n.sourceTable,i=r.find("tbody:eq(0)>tr"),s={},o=document.createDocumentFragment(),u=$(o);i.each(function(e,n){var r=$(this),i=r.get(0).cloneNode(!1),o=r.children("td,th"),a=0,f;$(i).addClass("CTF CTF"+e).removeAttr("id"),u.append(i),f=u.children("tr:last"),o.each(function(n,r){var i=$(this),o=i.attr("colspan"),u=i.attr("rowspan"),l={},c;if(a>=t)return!1;if(typeof u!="undefined"){u=parseInt(u,10),l={six:n,rowspan:u};for(var h=1;h<u;h++)n==0?s[e+h+(n+1).toString()]=l:s[e+h+n.toString()]=l}typeof o=="undefined"?a+=1:a+=parseInt(o,10),c=e+(n+1).toString(),c in s&&(a+=1),i.appendTo(f)})}),u.appendTo(e)},setWidth:function(e,t,n,r){var i=this.colWidth(),s=0,o,u=this.tableWidth(),a=0,r=$(r);for(o=e;o<n;o++)s+=i[o];s+=1,a=s/u,a*=100,$(t).css("width",a+"%"),r.length&&r.css("width",100-a+"%").find(">div").css("width",u-s-1)},fixWidth:function(){var t=e.Model.windowWidth,n=$(window).width(),r=this.selector().find(".js-roll-table"),i=r.width();t<n?(i+=n-t,r.width(i)):r.width(i)},setHeight:function(){var e=this,t=e.freezeType(),n=e.selector().find("div.js-fixed-table:eq(0)>table>thead>tr,div.js-fixed-table:eq(0)>table>tbody>tr"),r=e.selector().find("div.js-roll-table>table>thead>tr,div.js-roll-table>table>tbody>tr"),i=e.selector().find("div.js-fixed-table:eq(1)>table>thead>tr,div.js-fixed-table:eq(1)>table>tbody>tr");n.each(function(e,n){var s=r.eq(e),o=i.eq(e),u=$(n),a;a=Math.max(u.prop("offsetHeight"),s.prop("offsetHeight")),t=="both"&&(a=Math.max(a,o.prop("offsetHeight"))),u.height(a),s.height(a),t=="both"&&o.height(a)})},freezeType:function(){var e=this,t;return t=e.attrProp(e.selector(),"freezeType")||"prev",t},freezeCols:function(){var e=this,t;return t=e.attrProp(e.selector(),"freezeCols")||1,t=t.split(","),t},scrollwidth:function(){var e=this.attrProp("scrollwidth");return!e&&(e="120%"),e},needHoverClass:function(){var e=this.boolProp(this.selector().find("table").eq(0),"needHoverClass");return!e&&(e=!0),e},hoverClass:function(){var e=this.attrProp(this.selector().find("table").eq(0),"hoverClass");return!e&&(e="compTFHover"),e},tableWidth:function(){var e=this,t=e.selector().width(),n=e.selector().parent();for(;;){if(n&&n.prop("nodeName").toUpperCase()==="BODY")break;if(n.width()<t){t=n.width();break}n=n.parent()}return t},rowHeight:function(){var e=this,t=e.selector().find("table tr"),n=[];return t.each(function(){n.push($(this).prop("offsetHeight")+"px")}),n},scrollWidth:function(){var e=this;return e.selector().attr("scrollWidth")},colWidth:function(){var e=this,t=e.selector().find("table>thead th"),t,n=[],r=e.tableWidth();return t.each(function(){n.push($(this).prop("offsetWidth"))}),n},colNum:function(){var e=this,t=0;return t=e.selector().find("thead>tr>th").length,t},rowNum:function(){var e=this,t=0;return t=e.selector().find("tbody>tr").length,t},supportFreeze:function(){var e=this,t=!0;if(e.freezeCols().length==0||e.freezeCols().length==1&&parseInt(e.freezeCols(),10)==0||parseInt(e.freezeCols(),10)>e.colNum()||e.freezeCols().length==2&&parseInt(e.freezeCols()[0],10)+parseInt(e.freezeCols()[1],10)>=e.colNum())t=!1;return t},supportScroll:function(){var e=this,t=0,n=!0;return $.each(e.freezeCols(),function(e,n){t+=parseInt(n,10)}),t==e.colNum()&&(n=!1),n},hasFixedPXWidth:function(){var e=this,t=e.selector().get(0).style.width,n=e.selector().find("table").eq(0).attr("width")||e.selector().find("table").eq(0).get(0).style.width,r=e.tdThHasFixedPXWidth(),i=!0;if(t&&/%/.test(t))if(!n||n&&/%/.test(n))return!1;return!n||n&&/%/.test(n)?!1:r?!0:!1},tdThHasFixedPXWidth:function(){var e=this,t=e.selector().find("table").eq(0).find("tr").eq(0).find("th,td");return t.each(function(){var e=$(this),t=e.attr("width")||e.get(0).style.width;if(!t)return!1;if(t&&/%/.test(t))return!1}),!0},tTpl:function(){var e=this,t,n,r,i;t=e.selector().find("table").get(0).cloneNode(!1),n=e.selector().find("thead").get(0).cloneNode(!1),r=e.selector().find("tbody").get(0).cloneNode(!1),$(n).appendTo($(t)),$(r).appendTo($(t)),$(t).width("100%");switch(e.freezeType()){case"prev":case"last":i='<table class="compTFEextraTable"><tr><td class="compTFEextraTd"><div class="{0}" style="width:100%;">'+t.outerHTML+'</div></td><td class="compTFEextraTd"><div class="{1}" style="width:100%;">'+t.outerHTML+"</div></td>"+"</tr></table>";break;case"both":i='<table class="compTFEextraTable"><tr><td class="compTFEextraTd"><div class="{0}" style="width:100%;">'+t.outerHTML+'</div></td><td class="compTFEextraTd"><div class="{1}" style="width:100%;">'+t.outerHTML+'</div></td><td class="compTFEextraTd"><div class="{2}" style="width:100%;">'+t.outerHTML+"</div></td></tr></table>"}return i},beforeCreateTableCallback:function(){var e=this,t=e.selector(),n="beforeCreateTableCallback";return e.callbackProp(t,n)},afterCreateTableCallback:function(){var e=this,t=e.selector(),n="afterCreateTableCallback";return e.callbackProp(t,n)},baseTpl:'<div class="{0}" style="width:100%;"><table style="padding:0;margin:0;"><thead></thead><tbody></tbody></table></div>'}),JC.f.extendObject(e.View.prototype,{init:function(){var e=this;e._model.linkTpl()},update:function(){var e=this;if(!e._model.supportScroll())return;if(!e._model.supportFreeze()){e._model.selector().css({"overflow-x":"scroll"}).addClass("compTFAllRoll").children("table").css("width",e._model.scrollwidth());return}e._model.createTplBox(),e._model.detachTable(),e._model.fixWidth()}}),$(document).ready(function(){function r(){n.off("resize",r),$("div.js_compTableFreeze").each(function(){var t=e.getInstance($(this));t&&t.fixHeight(),e.Model.saveWidth=t._model.tableWidth()}),n.data("CTFResizeTimeout")&&clearTimeout(n.data("CTFResizeTimeout")),n.data("CTFResizeTimeout",setTimeout(function(){n.off("resize",r),n.on("resize",r)},200))}var t=0,n=$(window);e.Model.windowWidth=n.width(),e.autoInit&&(t=e.init()),n.on("resize",r)}),JC.TableFreeze})})(typeof define=="function"&&define.amd?define:function(e,t,n){typeof e=="function"&&(n=e),typeof t=="function"&&(n=t),n&&n()},window);