(function(e,t){e("Bizs.InputSelect",["JC.BaseMVC"],function(){function e(t){t&&(t=$(t));if(JC.BaseMVC.getInstance(t,e))return JC.BaseMVC.getInstance(t,e);JC.BaseMVC.getInstance(t,e,this),this._model=new e.Model(t),this._view=new e.View(this._model),this._init()}Bizs.InputSelect=e,JC.f.addAutoInit&&JC.f.addAutoInit(e),e.init=function(t){var n=[];return t=$(t||document),t.length&&(t.hasClass("js_bizInputSelect")?n.push(new e(t)):t.find(".js_bizInputSelect").each(function(){n.push(new e(this))})),n},BaseMVC.build(e),JC.f.extendObject(e.prototype,{_beforeInit:function(){var e=this;e._model.selector().addClass("IPTSEL-BOX").append('<span class="IPTSEL-ARROW"></span>'),e._model.iptselbox().length&&(e._model.iptselbox().addClass("IPTSEL-DROPDOWN"),e._model.iptselboxheight()&&e._model.iptselbox().css({height:e._model.iptselboxheight()+"px","overflow-y":"auto"})),e._model.iptseloption().length&&e._model.iptseloption().addClass("IPTSEL-ITEM")},_initHanlderEvent:function(){var e=this;e._model.selector().data("visible",0),e._model.iptselipt().on("keyup",function(t,n){var r=$(this),i=r.val().trim(),s=t.keyCode,o=r.data("IgnoreTime");if(s)switch(s){case 38:case 40:t.preventDefault();case 37:case 39:return;case 27:e._hide();return}}),e._model.iptselipt().on("click",function(){if(!e.selector().data("visible"))return;e._hide()}),e._model.iptselarrow().on("click",function(t){t.stopPropagation(),e._model.dataurl()&&!e._model.dataready&&e._model.ajaxdata(),e[e._model.selector().data("visible")?"_hide":"_show"]()}),e._model.iptselipt().on("keydown",function(t){var n=t.keyCode,r=$(this),i,s,o=e._model.iptseloption(),u;n==38&&(s=!0);switch(n){case 38:case 40:e._model.dataurl()&&e._model.iptselarrow().trigger("click"),e._show(),i=e._model.nextIndex(s);if(i>=0&&i<o.length){t.preventDefault(),u=$(o[i]),e._model.selectedIdentifier(u),e._model.iptselipt().val(e._model.getKeyword(u)),e._model.iptselhideipt().val(u.data("value")||"");return}break;case 9:e._hide();return;case 13:var a;e._model.iptselbox().is(":visible")&&(a=e._model.iptselbox().find("li.active"))&&a.length&&e.trigger("iptselitemselected",[a,e._model.getKeyword(a)]),e._hide(),e._model.iptselprevententer()&&t.preventDefault()}}),e._model.iptselbox().on("mousedown",function(e){e.stopPropagation()}),e._model.iptselbox().delegate(".IPTSEL-ITEM","mouseenter",function(t){var n=$(this);e._model.selectedIdentifier(n,!0)}).delegate(".IPTSEL-ITEM","mouseleave",function(e){var t=$(this);t.removeClass("active")}),e._model.iptselbox().delegate(".IPTSEL-ITEM","click",function(t){var n=$(this),r=n.data("label"),i=n.data("value")||"";e._model.iptselipt().val(r),e._model.iptselhideipt().val(i),e._hide(),e.trigger("iptselitemselected",[n,r,i]),JC.f.safeTimeout(function(){e._model.iptselipt().trigger("blur")},null,"IptSelItemClick",200)}),e.on("iptselitemselected",function(t,n,r,i){e._model.iptselitemselectedcallback()&&e._model.iptselitemselectedcallback().call(e,r,i)}),$(document).on("mousedown",function(){e._hide()})},_inited:function(){},_show:function(){var e=this;return e._view.show(),e._model.selector().data("visible",1),this},_hide:function(){var e=this;return e._view.hide(),e._model.selector().data("visible",0),this}}),e.Model._instanceName="InputSelectIns",JC.f.extendObject(e.Model.prototype,{init:function(){},iptselipt:function(){var e=JC.f.parentSelector(this.selector(),this.attrProp("iptselipt"));return e.length&&e.addClass("IPTSEL-INPUT"),e},iptselhideipt:function(){var e=JC.f.parentSelector(this.selector(),this.attrProp("iptselhideipt"));return e.length&&e.addClass("IPTSEL-HIDE"),e},iptselarrow:function(){return this.selector().find(".IPTSEL-ARROW")},iptseloption:function(){var e=this.selector();return JC.f.parentSelector(e,this.attrProp("iptseloption"))},iptselbox:function(){var e=this,t=e.attrProp("iptseldatabox");return JC.f.parentSelector(e.selector(),t)},iptselboxheight:function(){return this.intProp("iptselboxheight")},iptselprevententer:function(){var e=!0,t=this.selector();return t.is("[iptselprevententer]")&&(e=this.boolProp("iptselprevententer")),e},dataurl:function(){return this.attrProp("iptseldataurl")},ajaxdata:function(){var e=this,t=this.dataurl();$.get(t).done(function(t){t=$.parseJSON(t);var n="<ul>",r='<li data-label="{0}" data-keyindex="{1}" data-value="{2}" class="IPTSEL-ITEM">{0}</li>',i=0,s;if(t.errorno)JC.f.alert("操作失败",2);else{s=t.data.length;if(s===0)n="<li>暂无数据</li>";else for(i=0;i<s;i++)n+=JC.f.printf(r,t.data[i].label,i,t.data[i].value||"");n+="</ul>",e.iptselbox().html(n),e.dataready=1}})},nextIndex:function(e){var t=this,n=t.iptseloption(),r=n.length;return e?t.keyindex<=0?t.keyindex=r-1:t.keyindex--:t.keyindex>=r-1?t.keyindex=0:t.keyindex++,t.keyindex},selectedIdentifier:function(e,t){this.preSelected&&this.preSelected.removeClass("active"),e.addClass("active"),t&&(this.keyindex=parseInt(e.data("keyindex"))),this.preSelected=e},getKeyword:function(e){var t=e.data("label");try{t=decodeURIComponent(t)}catch(n){}return t},keyindex:-1,dataready:0,iptselitemselectedcallback:function(){var e=this;return e.selector().is("[iptselitemselectedcallback]")&&(e._iptselselectedcallback=e.selector().attr("iptselitemselectedcallback")),e._iptselselectedcallback?window[e._iptselselectedcallback]:null}}),JC.f.extendObject(e.View.prototype,{init:function(){},show:function(){var e=this;e._model.iptselbox().show().css("z-index",window.ZINDEX_COUNT++)},hide:function(){var e=this;e._model.iptselbox().hide()}});var t=$(document);return t.ready(function(){var t=0;e.autoInit&&(t=e.init())}),Bizs.InputSelect})})(typeof define=="function"&&define.amd?define:function(e,t,n){typeof e=="function"&&(n=e),typeof t=="function"&&(n=t),n&&n()},window);