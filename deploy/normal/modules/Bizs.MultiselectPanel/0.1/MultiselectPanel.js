(function(e,t){e("Bizs.MultiselectPanel",["JC.BaseMVC","JC.Panel"],function(){function n(e){e&&(e=$(e));if(JC.BaseMVC.getInstance(e,n))return JC.BaseMVC.getInstance(e,n);JC.BaseMVC.getInstance(e,n,this),this._model=new n.Model(e),this._view=new n.View(this._model),this._init(),JC.log(n.Model._instanceName,"all inited",(new Date).getTime())}var e=$(document),t=$(window);return Bizs.MultiselectPanel=n,n.init=function(e){var t=[];return e=$(e||document),e.length&&(e.hasClass("js_bizMultiselectPanel")?t.push(new n(e)):e.find("input.js_bizMultiselectPanel, button.js_bizMultiselectPanel").each(function(){t.push(new n(this))})),t},JC.BaseMVC.build(n),JC.f.extendObject(n.prototype,{_beforeInit:function(){},_initHanlderEvent:function(){var e=this;e.on("inited",function(){e.trigger("init_top")});var t=new JC.Panel(e._model.panel());e._model.panelIns(t),t.on("close",function(e,t){return t.hide(),!1}),t.on("hide",function(){JC.f.safeTimeout(function(){e.trigger("updateStatus")},e.selector(),"HIDE_PANEL",50)}),t.on("beforeshow",function(){JC.hideAllPanel()}),t.layout().on("click",function(t){JC.f.safeTimeout(function(){e.trigger("saveParentId")},e.selector(),"HIDE_PANEL",50)}),e._model.popupHideButton()&&t.offsetTop(-e.selector().prop("offsetHeight")-1),e.selector().on("click",function(n){t.show(e.selector())}),e.on("init_top",function(t){e._model.initTop(),e.trigger("saveParentId")}),e.on("updateTop",function(t,n,r){e._view.buildTop(n),e.trigger("saveParentId")}),e.on("updateChild",function(t,n,r,i){e._view.buildChild(n,r);var s=e._model.getCkItem(n);e._view.topCk(n,s.prop("checked"))}),t.layout().delegate("."+e._model.openClass(),"click",function(t){var n=$(this),r=n.data("id");n.addClass(e._model.closeClass()).removeClass(e._model.openClass()),e._view.showChild(r),e.trigger("initChildBox",[r])}),e.on("initChildBox",function(t,n){e._model.getChildBox(n).data("inited")||(e._model.getChildBox(n).data("inited",!0),e._model.initChild(n))}),t.layout().delegate("."+e._model.closeClass(),"click",function(t){var n=$(this),r=n.data("id");n.addClass(e._model.openClass()).removeClass(e._model.closeClass()),e._view.hideChild(r)}),t.layout().delegate("input.js_bmspTopCk","change",function(t){var n=$(this),r=n.val();e._view.topCk(r,n.prop("checked")),n.prop("checked")&&e.trigger("initChildBox",[r])}),t.layout().delegate("input.js_bmspChildCk","change",function(t){var n=$(this),r=n.val(),i=n.data("parentid");e._view.childCk(i,r)}),e.on("updateStatus",function(n){var r=t.find("input.js_bmspChildCk:checked");r.length?e.selector().val(JC.f.printf(e._model.hasItemText(),r.length)):e.selector().val(e._model.noItemText()),e.trigger("saveParentId")}),e.on("saveParentId",function(t){var n=e._model.saveTopIdSelector();if(n&&n.length){var r=e._model.panelIns().find("input.js_bmspTopCk:checked"),i=e._model.panelIns().find("input.js_bmspChildCk:checked"),s={},o=[];r.each(function(){var e=$(this).val();e in s||o.push(e),s[e]=""}),i.each(function(){var e=$(this).data("parentid");e in s||o.push(e),s[e]=""}),n.val(o.join(","))}})},_inited:function(){this.trigger("inited")}}),n.Model._instanceName="JCMultiselectPanel",JC.f.extendObject(n.Model.prototype,{init:function(){},url:function(){return this.attrProp("bmspUrl")},childUrl:function(){return this.attrProp("bmspChildUrl")},popupHideButton:function(){return this.boolProp("bmspPopupHideButton")},noDataFillSelf:function(){return this.boolProp("bmspNoDataFillSelf")},panel:function(){return this.selectorProp("bmspPanel")},panelIns:function(e){return typeof e!="undefined"&&(this._panelIns=e),this._panelIns},panelBoxSelector:function(){return this.panelIns().find(this.attrProp("bmspPanelBoxSelector")||"js_bmspPanelBox")},topTpl:function(){return this.scriptTplProp("bmspTopTpl")},childTpl:function(){return this.scriptTplProp("bmspChildTpl")},childBox:function(e){return e.find(".js_bmspChildBox")},openClass:function(){return this.attrProp("bmspOpenClass")},closeClass:function(){return this.attrProp("bmspCloseClass")},openSelector:function(){return this.selectorProp("."+this.openClass())},closeSelector:function(){return this.selectorProp("."+this.closeClass())},saveTopIdSelector:function(){return this.selectorProp("bmspSaveTopIdSelector")},initTop:function(){var e=this,t;$.get(e.url()).done(function(n){t=$.parseJSON(n),t&&!t.errorno&&t.data&&e.trigger("updateTop",[t.data,n])})},initChild:function(e){var t=this,n;$.get(JC.f.printf(t.childUrl(),e)).done(function(r){n=$.parseJSON(r),n&&!n.errorno&&n.data&&t.trigger("updateChild",[e,n.data,r])})},getChildBox:function(e){return this.panelIns().find(JC.f.printf(".js_bmspChildBox[data-id={0}]",e))},getIcon:function(e){return this.panelIns().find(JC.f.printf(".js_bmspIcon[data-id={0}]",e))},getCkItem:function(e){return this.panelIns().find(JC.f.printf("input.js_bmspCkItem[value={0}]",e))},noItemText:function(){return this.attrProp("bmspNoItemText")},hasItemText:function(){return this.attrProp("bmspHasItemText")}}),JC.f.extendObject(n.View.prototype,{init:function(){},buildTop:function(e){var t=this,n=t._model.panelBoxSelector(),r=t._model.topTpl(),i=[];$.each(e,function(e,t){i.push(JC.f.printf(r,t[0],t[1]))}),n.html(i.join(""))},buildChild:function(e,t){var n=this,r=n._model.getChildBox(e),i=n._model.childTpl(),s=[];if(n._model.noDataFillSelf()&&t&&!t.length){var o=n._model.getCkItem(e),u=o.data("label")||"";t.push([e,u])}$.each(t,function(t,n){s.push(JC.f.printf(i,n[0],n[1],e))}),r.html(s.join(""))},showChild:function(e){this._model.getChildBox(e).show()},hideChild:function(e){this._model.getChildBox(e).hide()},topCk:function(e,t){var n=this._model.getChildBox(e);n.find("input.js_bmspChildCk").prop("checked",t)},childCk:function(e,t){var n=this,r=this._model.getChildBox(e),i=n._model.getCkItem(e);r.find("input.js_bmspChildCk:not(:checked)").length?i.prop("checked",!1):i.prop("checked",!0)}}),t.on("BMSP_AUTO_FILL_DEFAULT_DATA",function(e,n){var r,i,s;if(!(n&&n.length&&n.attr("bmspDefaultFillData")&&(s=window[n.attr("bmspDefaultFillData")]))&&s.parents)return;t.trigger("BMSP_AUTO_FILL",[n,s.parents,s.children])}),t.on("BMSP_AUTO_FILL_URL_DATA",function(e,n){var r,i;if(!(n.attr("bmspAutoFillTopKey")&&(r=JC.f.getUrlParams(n.attr("bmspAutoFillTopKey")))&&r.length))return;r=decodeURIComponent(r).split(","),i=JC.f.getUrlParams(n.attr("bmspAutoFillChildKey")),t.trigger("BMSP_AUTO_FILL",[n,r,i])}),t.on("BMSP_AUTO_FILL",function(e,t,n,r){if(!(t&&t.length&&n&&n.length))return;var i,s;s=JC.BaseMVC.getInstance(t,Bizs.MultiselectPanel)||new Bizs.MultiselectPanel(t),i=n.slice(),s.on("updateTop",function(){if(n.length){var e=n.shift();s.trigger("initChildBox",[e]),s._model.getIcon(e).trigger("click"),s.on("updateChild",function(){n.length?(e=n.shift(),s.trigger("initChildBox",[e]),s._model.getIcon(e).trigger("click")):i.length&&(r&&r.length&&(r&&r.length&&$.each(r,function(e,t){s._model.getCkItem(t).prop("checked",!0)}),$.each(i,function(e,t){s._view.childCk(t)}),s.trigger("updateStatus")),i=[])})}})}),e.ready(function(){e.delegate("input.js_bizMultiselectPanel","click",function(e){var t=$(this),n;JC.BaseMVC.getInstance(t,Bizs.MultiselectPanel)||(n=new Bizs.MultiselectPanel(t),n._model.panelIns().show(t))}),$("input.js_bizMultiselectPanel").each(function(){var e=$(this);e.attr("bmspDefaultFillData")&&window[e.attr("bmspDefaultFillData")]?t.trigger("BMSP_AUTO_FILL_DEFAULT_DATA",[e]):e.attr("bmspAutoFillTopKey")&&t.trigger("BMSP_AUTO_FILL_URL_DATA",[e])})}),Bizs.MultiselectPanel})})(typeof define=="function"&&define.amd?define:function(e,t,n){typeof e=="function"&&(n=e),typeof t=="function"&&(n=t),n&&n()},window);